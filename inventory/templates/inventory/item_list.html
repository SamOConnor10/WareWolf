{% extends "inventory/base_stock.html" %}
{% load querystring %}

{% block stock_content %}

<div class="row">

    <!-- RIGHT SIDE — STOCK ITEMS TABLE (default) -->
    <div class="col-md-12">

        <h1 class="fw-bold">Stock Items</h1>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <p class="text-muted">Manage your warehouse stock levels</p>

            {% if perms.inventory.add_item %}
                <a href="{% url 'item_create' %}" class="btn btn-primary">+ Add Item</a>
            {% endif %}
        </div>

        <!-- SEARCH + FILTER -->
        <form method="GET" class="row g-2 mb-4">

            <div class="col-md-4">
                <input type="text" name="q" class="form-control"
                       placeholder="Search items..."
                       value="{{ request.GET.q }}">
            </div>

            <div class="col-md-3">
                <select name="filter" class="form-select">
                    <option value="">All Items</option>
                    <option value="in_stock" {% if filter_option == 'in_stock' %}selected{% endif %}>In Stock</option>
                    <option value="low_stock" {% if filter_option == 'low_stock' %}selected{% endif %}>Low Stock</option>
                    <option value="out_of_stock" {% if filter_option == 'out_of_stock' %}selected{% endif %}>Out of Stock</option>
                </select>
            </div>

            <div class="col-md-2 d-grid">
                <button class="btn btn-secondary">Apply</button>
            </div>

            <div class="col-md-3 d-grid">
                <a href="{% url 'item_export_csv' %}" class="btn btn-outline-success">Export CSV</a>
            </div>
        </form>

        <!-- STOCK TABLE -->
        <table class="table table-hover bg-white shadow-sm">
            <thead class="table-light">
                <tr>
                    <th><a href="?{% querystring request sort='name' %}">Name</a></th>
                    <th><a href="?{% querystring request sort='sku' %}">SKU</a></th>
                    <th><a href="?{% querystring request sort='quantity' %}">Qty</a></th>
                    <th><a href="?{% querystring request sort='category__name' %}">Category</a></th>
                    <th><a href="?{% querystring request sort='reorder_level' %}">Reorder</a></th>
                    <th><a href="?{% querystring request sort='supplier__name' %}">Supplier</a></th>
                    <th><a href="?{% querystring request sort='location__name' %}">Location</a></th>
                    <th>Status</th>
                    <th style="width:160px;">Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for item in items %}
                <tr
                    {% if item.quantity <= 0 %}
                        class="table-danger"
                    {% elif item.quantity <= item.reorder_level %}
                        class="table-warning"
                    {% endif %}
                >
                    <td>{{ item.name }}</td>
                    <td>{{ item.sku }}</td>
                    <td>{{ item.quantity }}</td>

                    <td>
                        {% if item.category %}
                            {{ item.category.full_path }}
                        {% else %}
                            —
                        {% endif %}
                    </td>

                    <td>{{ item.reorder_level }}</td>
                    <td>{{ item.supplier.name }}</td>
                    <td>{{ item.location.name }}</td>

                    <td>
                        {% if item.quantity <= 0 %}
                            <span class="text-danger fw-bold">Out</span>
                        {% elif item.quantity <= item.reorder_level %}
                            <span class="text-warning fw-bold">Low</span>
                        {% else %}
                            <span class="text-success fw-bold">In Stock</span>
                        {% endif %}
                    </td>

                    <td>
                        {% if perms.inventory.change_item %}
                            <a href="{% url 'item_adjust' item.id %}" class="btn btn-sm btn-outline-primary">Adjust</a>
                            <a href="{% url 'item_edit' item.id %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                        {% endif %}

                        {% if perms.inventory.delete_item %}
                            <a href="{% url 'item_delete' item.id %}" class="btn btn-sm btn-outline-danger">Delete</a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="9" class="text-center text-muted py-4">No items found.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- PAGINATION -->
        <div class="d-flex justify-content-center mt-3">
            {% if items.has_other_pages %}
                <nav>
                    <ul class="pagination">
                        {% if items.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% querystring request page=items.previous_page_number %}">Prev</a>
                            </li>
                        {% endif %}

                        {% for num in items.paginator.page_range %}
                            <li class="page-item {% if items.number == num %}active{% endif %}">
                                <a class="page-link" href="?{% querystring request page=num %}">{{ num }}</a>
                            </li>
                        {% endfor %}

                        {% if items.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% querystring request page=items.next_page_number %}">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>

    </div>
</div>

{% endblock stock_content %}
