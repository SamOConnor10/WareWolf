{% extends "inventory/base.html" %}
{% load static %}
{% block content %}

<h1 class="fw-bold mb-1">Suppliers & Customers</h1>
<p class="text-muted">Manage your business relationships</p>

<!-- SUMMARY CARDS -->
<div class="row mb-4">

    <div class="col-md-4">
        <div class="card shadow-sm border-0 p-3">
            <h6 class="text-muted mb-1">Total Suppliers</h6>
            <div class="fs-3 fw-bold">{{ total_suppliers }}</div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-0 p-3">
            <h6 class="text-muted mb-1">Total Customers</h6>
            <div class="fs-3 fw-bold">{{ total_customers }}</div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow-sm border-0 p-3">
            <h6 class="text-muted mb-1">Active Relationships</h6>
            <div class="fs-3 fw-bold">{{ active_relationships }}</div>
        </div>
    </div>
</div>

<!-- ANALYTICS ROW (Optional but great visually) -->
<div class="row mb-4">

    <div class="col-md-6">
        <div class="card shadow-sm border-0 p-3">
            <h6 class="text-muted mb-1">Top Customer</h6>
            {% if top_customer %}
                <div class="fw-bold">{{ top_customer.name }}</div>
                <small class="text-muted">€{{ top_customer.total_value }} in orders</small>
            {% else %}
                <div class="text-muted">No customers yet</div>
            {% endif %}
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm border-0 p-3">
            <h6 class="text-muted mb-1">Top Supplier</h6>
            {% if top_supplier %}
                <div class="fw-bold">{{ top_supplier.name }}</div>
                <small class="text-muted">{{ top_supplier.orders }} orders supplied</small>
            {% else %}
                <div class="text-muted">No suppliers yet</div>
            {% endif %}
        </div>
    </div>

</div>

<!-- SEARCH BAR -->
<form method="get" class="mb-3">
    <div class="input-group shadow-sm">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input type="text" name="q" class="form-control"
               placeholder="Search name, email, phone…"
               value="{{ request.GET.q }}">
        <button class="btn btn-outline-secondary">Search</button>
    </div>
</form>

<!-- FILTER BUTTONS + ADD BUTTON -->
<div class="d-flex justify-content-between align-items-center mb-3">

    <div class="btn-group">
        <a href="?type=all" class="btn {% if type_filter == 'all' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
            All
        </a>
        <a href="?type=suppliers" class="btn {% if type_filter == 'suppliers' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
            Suppliers
        </a>
        <a href="?type=customers" class="btn {% if type_filter == 'customers' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
            Customers
        </a>
    </div>

    {% if type_filter == "suppliers" %}
        {% if perms.inventory.add_supplier %}
            <a href="{% url 'supplier_create' %}" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> Add Supplier
            </a>
        {% endif %}
    {% elif type_filter == "customers" %}
        {% if perms.inventory.add_client %}
            <a href="{% url 'client_create' %}" class="btn btn-primary">
                <i class="bi bi-person-plus"></i> Add Customer
            </a>
        {% endif %}
    {% else %}
        {% if perms.inventory.add_supplier or perms.inventory.add_client %}
            {% if perms.inventory.add_supplier %}
                <a href="{% url 'supplier_create' %}" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i> Add Contact
                </a>
            {% elif perms.inventory.add_client %}
                <a href="{% url 'client_create' %}" class="btn btn-primary">
                    <i class="bi bi-person-plus"></i> Add Contact
                </a>
            {% endif %}
        {% endif %}
    {% endif %}
</div>

<!-- CONTACTS TABLE -->
<div class="table-responsive shadow-sm bg-white rounded">
<table class="table table-hover align-middle mb-0">
    <thead class="table-light">
        <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Contact Info</th>
            <th>Orders</th>
            <th>Total Value</th>
            <th class="text-end">Actions</th>
        </tr>
    </thead>

    <tbody>
        {% for c in contacts %}
        <tr>
            <td class="fw-semibold">{{ c.name }}</td>

            <td>
                {% if c.type == "supplier" %}
                    <span class="badge bg-info">Supplier</span>
                {% else %}
                    <span class="badge bg-success">Customer</span>
                {% endif %}
            </td>

            <td>
                <div><i class="bi bi-envelope"></i> {{ c.email }}</div>
                <div><i class="bi bi-telephone"></i> {{ c.phone }}</div>
            </td>

            <td>{{ c.orders }}</td>
            <td>€{{ c.total_value }}</td>

            <td class="text-end">

                {% if c.type == "supplier" %}
                    {% if perms.inventory.change_supplier %}
                        <a href="{% url 'supplier_edit' c.id %}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-pencil"></i>
                        </a>
                    {% endif %}
                    {% if perms.inventory.delete_supplier %}
                        <a href="{% url 'supplier_delete' c.id %}" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i>
                        </a>
                    {% endif %}

                {% else %}

                    {% if perms.inventory.change_client %}
                        <a href="{% url 'client_edit' c.id %}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-pencil"></i>
                        </a>
                    {% endif %}
                    {% if perms.inventory.delete_client %}
                        <a href="{% url 'client_delete' c.id %}" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i>
                        </a>
                    {% endif %}

                {% endif %}

            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center text-muted p-3">No contacts found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<!-- PAGINATION -->
{% if pagination %}
<nav class="mt-3">
    <ul class="pagination">

        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&type={{ type_filter }}&q={{ request.GET.q }}">Previous</a>
        </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if num == page_obj.number %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}&type={{ type_filter }}&q={{ request.GET.q }}">{{ num }}</a>
            </li>
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}&type={{ type_filter }}&q={{ request.GET.q }}">Next</a>
        </li>
        {% endif %}

    </ul>
</nav>
{% endif %}

{% endblock %}
